apiVersion: helm.toolkit.fluxcd.io/v2beta2
kind: HelmRelease
metadata:
  annotations:
    reconcile.fluxcd.io/requestedAt: "1702682897"
  creationTimestamp: "2023-09-15T22:23:37Z"
  finalizers:
  - finalizers.fluxcd.io
  generation: 32
  labels:
    app.kubernetes.io/instance: immich
    app.kubernetes.io/name: immich
    app.kubernetes.io/part-of: immich
    kustomize.toolkit.fluxcd.io/name: immich
    kustomize.toolkit.fluxcd.io/namespace: flux-system
  name: immich-server
  namespace: media
  resourceVersion: "43120865"
  uid: 2751901d-51b8-4eb6-bd88-5f96d69210e3
spec:
  chart:
    spec:
      chart: app-template
      interval: 30m
      reconcileStrategy: ChartVersion
      sourceRef:
        kind: HelmRepository
        name: bjw-s
        namespace: flux-system
      version: 2.4.0
  interval: 30m
  values:
    controllers:
      main:
        annotations:
          reloader.stakater.com/auto: "true"
        containers:
          main:
            args:
            - start-server.sh
            env:
              DB_DATABASE_NAME:
                value: app
              DB_HOSTNAME:
                value: immich-rw.media.svc.cluster.local
              DB_PASSWORD:
                valueFrom:
                  secretKeyRef:
                    key: password
                    name: immich-app
              DB_USERNAME:
                valueFrom:
                  secretKeyRef:
                    key: username
                    name: immich-app
              IMMICH_MEDIA_LOCATION: /usr/src/app/upload
              LOG_LEVEL: log
              PUBLIC_IMMICH_SERVER_URL:
                valueFrom:
                  configMapKeyRef:
                    key: PUBLIC_IMMICH_SERVER_URL
                    name: immich-configmap
              REDIS_HOSTNAME:
                valueFrom:
                  configMapKeyRef:
                    key: REDIS_HOSTNAME
                    name: immich-configmap
              REDIS_PORT:
                valueFrom:
                  configMapKeyRef:
                    key: REDIS_PORT
                    name: immich-configmap
              SERVER_PORT: 3001
            image:
              repository: ghcr.io/immich-app/immich-server
              tag: v1.91.0
            resources:
              limits:
                memory: 512Mi
              requests:
                cpu: 100m
                memory: 256Mi
        pod:
          enableServiceLinks: false
          securityContext:
            fsGroup: 568
            fsGroupChangePolicy: OnRootMismatch
            runAsGroup: 568
            runAsUser: 568
            supplementalGroups:
            - 65542
        strategy: RollingUpdate
    ingress:
      main:
        annotations:
          gethomepage.dev/description: Fotos
          gethomepage.dev/enabled: "true"
          gethomepage.dev/group: Medien
          gethomepage.dev/icon: immich
          gethomepage.dev/name: Photos
          gethomepage.dev/pod-selector: |-
            app.kubernetes.io/instance in (

                immich-server,
                immich-microservices,
                immich-typesense,
                immich-machine-learning
            )
          gethomepage.dev/widget.fields: '["photos", "videos", "storage"]'
          gethomepage.dev/widget.key: '{{HOMEPAGE_VAR_IMMICH_APIKEY}}'
          gethomepage.dev/widget.type: immich
          gethomepage.dev/widget.url: https://photos.home.lucadev.de
        enabled: true
        hosts:
        - host: photos.home.lucadev.de
          paths:
          - path: /
            pathType: Prefix
            service:
              name: main
              port: http
        tls:
        - hosts:
          - photos.home.lucadev.de
    persistence:
      library:
        existingClaim: immich-data
        globalMounts:
        - path: /usr/src/app/upload
        type: persistentVolumeClaim
    service:
      main:
        ports:
          http:
            port: 3001
status:
  conditions:
  - lastTransitionTime: "2023-12-15T23:25:54Z"
    message: Fulfilling prerequisites
    observedGeneration: 32
    reason: Progressing
    status: "True"
    type: Reconciling
  - lastTransitionTime: "2023-12-15T23:25:54Z"
    message: 'unable to get ''media/immich-typesense'' dependency: HelmRelease.helm.toolkit.fluxcd.io
      "immich-typesense" not found'
    observedGeneration: 32
    reason: DependencyNotReady
    status: "False"
    type: Ready
  - lastTransitionTime: "2023-12-15T23:25:54Z"
    message: 'Helm upgrade failed for release media/immich-server with chart app-template@2.4.0:
      context deadline exceeded'
    observedGeneration: 32
    reason: UpgradeFailed
    status: "False"
    type: Released
  failures: 1
  helmChart: flux-system/media-immich-server
  history:
  - chartName: app-template
    chartVersion: 2.4.0
    configDigest: sha256:a7f7fe4a6a38ea516cca36c4bc984f4af5d4d2dd89321d9379951d61f5ac43e2
    digest: sha256:d6aa4d9957bc871946ccb094a0ac65073bba6c7f50ba1aed9980292608a819de
    firstDeployed: "2023-09-16T14:35:08Z"
    lastDeployed: "2023-12-15T23:20:52Z"
    name: immich-server
    namespace: media
    status: failed
    version: 31
  - chartName: app-template
    chartVersion: 2.4.0
    configDigest: sha256:41c3e8b627e733680dca0b8c2f82fe0f91b41013d888b26e261874f3665751ac
    digest: sha256:6ec99c5a8fd6fb221dedb9f9ddcc2dbab310359e77b0e446a22a56c2714c7cf0
    firstDeployed: "2023-09-16T14:35:08Z"
    lastDeployed: "2023-12-10T21:11:57Z"
    name: immich-server
    namespace: media
    status: deployed
    version: 30
  lastAppliedRevision: 2.4.0
  lastAttemptedConfigDigest: sha256:a7f7fe4a6a38ea516cca36c4bc984f4af5d4d2dd89321d9379951d61f5ac43e2
  lastAttemptedGeneration: 31
  lastAttemptedReleaseAction: upgrade
  lastAttemptedRevision: 2.4.0
  lastHandledReconcileAt: "1702682897"
  observedGeneration: 31
  storageNamespace: media
  upgradeFailures: 1
