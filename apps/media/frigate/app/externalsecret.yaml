---
# yaml-language-server: $schema=https://raw.githubusercontent.com/datreeio/CRDs-catalog/main/external-secrets.io/externalsecret_v1beta1.json
apiVersion: external-secrets.io/v1
kind: ExternalSecret
metadata:
  name: frigate
spec:
  secretStoreRef:
    kind: ClusterSecretStore
    name: bitwarden-fields
  target:
    name: frigate-secret
    creationPolicy: Owner
    template:
      data:
        config.yml: |
          tls:
            enabled: False

          ffmpeg:
            hwaccel_args: preset-vaapi

          auth:
            enabled: False

          motion:
            enabled: True

          record:
            enabled: True

          snapshots:
            enabled: True

          birdseye:
            enabled: True
            mode: continuous

          mqtt:
            enabled: True
            host: mosquitto.home-automation.svc.cluster.local
            user: {{ .mqtt_user }}
            password: {{ .mqtt_password }}

          cameras:
            dachboden:
              enabled: True
              ffmpeg:
                output_args:
                  record: preset-record-generic-audio-aac
                inputs:
                  - path: rtsp://127.0.0.1:8554/dachboden
                    roles:
                      - record
                  - path: rtsp://127.0.0.1:8554/dachboden_sub
                    roles:
                      - detect
                      - audio
              detect:
                enabled: True
              onvif:
                host: 192.168.100.32
                port: 2020
                user: {{ .tapo_user }}
                password: {{ .camera_password }}
              record:
                enabled: True
                retain:
                  days: 30
                  mode: motion
                detections:
                  retain:
                    days: 30
                    mode: motion
              lpr:
                enabled: False
              motion:
                mask:
                  - "0.358,0.000,0,0,0.000,0.047,0.358,0.047"
            eingang:
              enabled: True
              ffmpeg:
                output_args:
                  record: preset-record-generic-audio-copy
                inputs:
                  - path: rtsp://127.0.0.1:8554/eingang
                    roles:
                      - record
                  - path: rtsp://127.0.0.1:8554/eingang_sub
                    roles:
                      - detect
                      - audio
              detect:
                enabled: True
              onvif:
                host: 192.168.100.100
                port: 2020
                user: rtsp
                password: {{ .camera_password_short }}
              record:
                enabled: True
                retain:
                  days: 3
                  mode: all
                alerts:
                  retain:
                    days: 30
                    mode: motion
                detections:
                  retain:
                    days: 30
                    mode: motion
              motion:
                mask:
                  - "0.02,0.05,0.02,0.1,0.265,0.100,0.265,0.05"
            #garage:
            #  enabled: True
            #  ffmpeg:
            #    inputs:
            #      - path: rtsp://rtsp:{{ .camera_password }}@192.168.1.57/Streaming/channels/101
            #        roles:
            #          - record
            #      - path: rtsp://rtsp:{{ .camera_password }}@192.168.1.57/Streaming/channels/102
            #        roles:
            #          - detect
            #          - audio
            #  detect:
            #    enabled: True
            #  onvif:
            #    host: 192.168.1.57
            #    port: 2020
            #    user: rtsp
            #    password: {{ .camera_password }}

          go2rtc:
            streams:
              dachboden:
                - tapo://{{ .tapo_password }}@192.168.100.32/stream1
                - rtsp://{{ .tapo_user }}:{{ .camera_password }}@192.168.1.45/stream1
                - "ffmpeg:dachboden#audio=opus"
              dachboden_sub:
                - tapo://{{ .tapo_password }}@192.168.100.32/stream2
                - rtsp://{{ .tapo_user }}:{{ .camera_password }}@192.168.1.45/stream2
                - "ffmpeg:dachboden_sub#audio=opus"
              eingang:
                - rtsp://rtsp:{{ .camera_password_short }}@192.168.100.100/Streaming/channels/101
                - "ffmpeg:eingang#audio=opus"
              eingang_sub:
                - rtsp://rtsp:{{ .camera_password_short }}@192.168.100.100/Streaming/channels/101
                - "ffmpeg:eingang_sub#audio=opus"
            webrtc:
              candidates:
                - 192.168.1.169:8555

          detectors:
            ov:
              type: openvino

          model:
            model_type: yolonas
            width: 320
            height: 320
            input_pixel_format: bgr
            input_tensor: nchw
            path: /config/model_cache/yolo_nas_s.onnx
            labelmap_path: /labelmap/coco-80.txt

          audio:
            enabled: True

          face_recognition:
            enabled: true

          lpr:
            enabled: True
  data:
    - secretKey: tapo_password
      remoteRef:
        key: Tapo
        property: tapo_password
    - secretKey: tapo_user
      remoteRef:
        key: Tapo
        property: user
    - secretKey: camera_password
      remoteRef:
        key: Tapo
        property: password
    - secretKey: camera_password_short
      remoteRef:
        key: Tapo
        property: password_short
    - secretKey: mqtt_user
      remoteRef:
        key: mosquitto
        property: frigate_username
    - secretKey: mqtt_password
      remoteRef:
        key: mosquitto
        property: frigate_password
