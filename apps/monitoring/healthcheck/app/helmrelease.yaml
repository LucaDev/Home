---
apiVersion: helm.toolkit.fluxcd.io/v2
kind: HelmRelease
metadata:
  name: healthcheck
spec:
  interval: 1h
  chartRef:
    kind: OCIRepository
    name: app-template-4
    namespace: flux-system
  values:
    controllers:
      main:
        containers:
          - name: curl
            image: quay.io/curl/curl:8.17.0
            imagePullPolicy: IfNotPresent
            command:
              - /bin/sh
              - -c
              - |-
                while true; do
                  curl -m 10 --retry 5 --silent "$HEALTHCHECK_URL"
                  echo "[$(date -u '+%Y-%m-%d %H:%M:%S UTC')] Heartbeat sent."
                  sleep 60
                done
            envFrom:
              - secretRef:
                  name: healthcheck-secret
