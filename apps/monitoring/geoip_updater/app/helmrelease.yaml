---
apiVersion: helm.toolkit.fluxcd.io/v2
kind: HelmRelease
metadata:
  name: geoip-updater
spec:
  interval: 30m
  chartRef:
    kind: OCIRepository
    name: app-template-4
    namespace: flux-system
  values:
    controllers:
      geoip-updater-asn:
        type: cronjob
        cronjob:
          schedule: "12 4 * * *"
          backoffLimit: 0
          concurrencyPolicy: Forbid
          failedJobsHistory: 1
          successfulJobsHistory: 1
        pod: &pod
          securityContext:
            fsGroup: 2000
            fsGroupChangePolicy: "OnRootMismatch"
            runAsGroup: 2000
            runAsNonRoot: true
            runAsUser: 2000
        containers:
          app:
            image: &image
              repository: ghcr.io/maxmind/geoipupdate
              tag: v7.1.1
            securityContext: &sc
            resources: &resources
            env:
              GEOIPUPDATE_EDITION_IDS: "GeoLite2-ASN"
            envFrom: &envFrom
              - secretRef:
                  name: maxmind-credentials
      geoip-updater-city:
        type: cronjob
        cronjob:
          schedule: "44 4 * * *"
          backoffLimit: 0
          concurrencyPolicy: Forbid
          failedJobsHistory: 1
          successfulJobsHistory: 1
        pod: *pod
        containers:
          app:
            image: *image
            securityContext: *sc
            resources: *resources
            env:
              GEOIPUPDATE_EDITION_IDS: "GeoLite2-City"
            envFrom: *envFrom

    persistence:
      storage:
        type: persistentVolumeClaim
        accessMode: ReadWriteOnce
        size: 2Gi
        storageClass: ssd-singlereplica
        globalMounts:
          - path: /usr/share/GeoIP
