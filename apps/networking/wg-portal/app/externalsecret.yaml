---
# yaml-language-server: $schema=https://raw.githubusercontent.com/datreeio/CRDs-catalog/main/external-secrets.io/externalsecret_v1beta1.json
apiVersion: external-secrets.io/v1
kind: ExternalSecret
metadata:
  name: wg-portal
spec:
  secretStoreRef:
    kind: ClusterSecretStore
    name: bitwarden-fields
  target:
    name: wg-portal
    creationPolicy: Owner
    template:
      data:
        config.yaml: |
          core:
            admin_user: {{.WGPORTAL_ADMIN_USER}}
            admin_password: {{.WGPORTAL_ADMIN_PASSWORD}}

          web:
            site_title: LucaDev VPN
            site_company_name: LucaDev
            listening_address: :8080
            external_url: https://vpn.lucadev.de
            csrf_secret: {{.WGPORTAL_CSRF_SECRET}}
            session_secret: {{.WGPORTAL_SESSION_SECRET}}
            request_logging: true

          backend:
            default: mikrotik-prod

            mikrotik:
              - id: mikrotik-prod
                display_name: Router RB4011
                api_url: https://192.168.1.1/rest
                api_user: wgportal
                api_password: {{.MIKROTIK_WGPORTAL_PASSWORD}}
                api_verify_tls: true
                api_timeout: 30s
                concurrency: 5
                debug: false

          auth:
            - id: kanidm
              provider_name: IDM
              display_name: Login with</br>SSO
              base_url: https://idm.lucadev.de
              client_id: vpn
              client_secret: {{.WGPORTAL_OIDC_SECRET}}
              extra_scopes:
                - groups
                - email
              field_map:
                user_identifier: sub
                email: email
                firstname: given_name
                lastname: family_name
                phone: phone_number
                department: department
                user_groups: groups
              admin_mapping:
                admin_group_regex: ^admins$
              registration_enabled: true
              log_user_info: true
  data:
    - secretKey: WGPORTAL_OIDC_SECRET
      remoteRef:
        key: wg-portal
        property: OIDC_SECRET
    - secretKey: MIKROTIK_WGPORTAL_PASSWORD
      remoteRef:
        key: wg-portal
        property: MIKROTIK_PASSWORD
    - secretKey: WGPORTAL_SESSION_SECRET
      remoteRef:
        key: wg-portal
        property: SESSION_SECRET
    - secretKey: WGPORTAL_CSRF_SECRET
      remoteRef:
        key: wg-portal
        property: CSRF_SECRET
    - secretKey: WGPORTAL_ADMIN_USER
      remoteRef:
        key: wg-portal
        property: ADMIN_USER
    - secretKey: WGPORTAL_ADMIN_PASSWORD
      remoteRef:
        key: wg-portal
        property: ADMIN_PASSWORD
