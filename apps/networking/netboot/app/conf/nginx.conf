server {
    listen 80;
    server_name localhost;

    location / {
        root /media;
        autoindex on;
    }

    location /configure {
        content_by_lua_block {
            local args = ngx.req.get_uri_args()
            local system = args.system or "unknown"

            -- Set headers for file download
            ngx.header["Content-Disposition"] = 'attachment; filename="configure.bat"'
            ngx.header["Content-Type"] = "text/plain"

            -- Send response
            ngx.say([[@echo off
Wpeutil InitializeNetwork
:START
ping -n 1 homeserver
if errorlevel 1 GOTO START
net use m: \\homeserver\WindowsISOs /user:guest guest
m:\]] .. system .. [[\setup.exe]])
        }
    }

    location /winpeshl {
        content_by_lua_block {
            -- Set headers for file download
            ngx.header["Content-Disposition"] = 'attachment; filename="configure.bat"'
            ngx.header["Content-Type"] = "text/plain"

            -- Send response
            ngx.say([[[LaunchApp]
AppPath = configure.bat]])
        }
    }
}
