server {
    listen 80;
    server_name localhost;

    location / {
        root /media;
        autoindex on;
    }

    location /configure {
        content_by_lua_block {
            local args = ngx.req.get_uri_args()
            local system = args.system or "unknown"
            local arch = args.arch or "x64"

            -- Set headers for file download
            ngx.header["Content-Disposition"] = 'attachment; filename="configure.bat"'
            ngx.header["Content-Type"] = "text/plain"

            -- Send response
            ngx.print("@echo off\r\nWpeutil InitializeNetwork\r\n:START\r\nping -n 1 homeserver\r\nif errorlevel 1 GOTO START\r\nnet use m: \\\\homeserver.local\\WindowsISOs /user:guest\r\nm:\\" .. system .. "\\" .. arch .. "\\setup.exe")
        }
    }

    location /winpeshl {
        content_by_lua_block {
            -- Set headers for file download
            ngx.header["Content-Disposition"] = 'attachment; filename="winpeshl.ini"'
            ngx.header["Content-Type"] = "text/plain"

            -- Send response
            ngx.print("[LaunchApp]\r\nAppPath = configure.bat")
        }
    }
}
