server {
    listen 80;
    server_name localhost;

    location / {
        root /media;
        autoindex on;
    }

    location /configure {
        content_by_lua_block {
            local args = ngx.req.get_uri_args()
            local system = args.system or "unknown"
            local arch = args.arch or "x64"

            -- Set headers for file download
            ngx.header["Content-Disposition"] = 'attachment; filename="configure.bat"'
            ngx.header["Content-Type"] = "text/plain"

            -- Send response
            ngx.print("@echo off\r\nWpeutil InitializeNetwork\r\n:START\r\nping -n 1 homeserver\r\nif errorlevel 1 GOTO START\r\nnet use m: \\\\homeserver.local\\WindowsISOs /user:guest\r\nstart m:\\" .. system .. "\\" .. arch .. "\\setup.exe")
        }
    }

    location /winpeshl {
        content_by_lua_block {
            -- Set headers for file download
            ngx.header["Content-Disposition"] = 'attachment; filename="winpeshl.ini"'
            ngx.header["Content-Type"] = "text/plain"

            -- Send response
            ngx.print("[LaunchApp]\r\nAppPath = configure.bat")
        }
    }

    location /custom.ipxe {
        content_by_lua_block {
            local template_path = "/templates/custom.ipxe"
            local placeholder = "{{WINVERSIONS}}"
            local media_dir = "/media/"

            local template_file = io.open(template_path, "r")
            if not template_file then
                ngx.say("Err: unable to open template file")
                return
            end

            local template_content = template_file:read("*a")
            template_file:close()
            if not template_content then
                ngx.say("Err: unable to read template file")
                return
            end

            local handle = io.popen("find " .. media_dir .. " -maxdepth 1 -type d -exec basename {} \\; | grep -v '^$' | grep -v '^WinPE$' | grep -v '^media$'")
            if not handle then
                ngx.say("Err: unable to get folder list")
                return
            end

            local windows_versions = {}
            for line in handle:lines() do
                local name = line:gsub("_", " ")
                table.insert(windows_versions, "item " .. line .. " " .. name)
            end
            handle:close()

            ngx.print(template_content:gsub(placeholder, table.concat(windows_versions, "\n")))
        }
    }
}
